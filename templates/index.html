<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Chat App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 md:p-8">
            <!-- Login Form -->
            <div id="login-form" class="space-y-4 max-w-md mx-auto">
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 text-center mb-6">Join Chat</h2>
                <div class="space-y-3">
                    <input type="text" id="username" placeholder="Username" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                    <input type="text" id="room" placeholder="Room Name" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                    <button onclick="joinRoom()" 
                            class="w-full bg-blue-500 text-white py-3 px-4 rounded-lg hover:bg-blue-600 transition duration-200 font-medium text-lg">
                        Join
                    </button>
                </div>
            </div>

            <!-- Chat Interface -->
            <div id="chat-interface" class="hidden space-y-4">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6">
                    <div class="flex items-center space-x-2">
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Room:</h2>
                        <span id="room-display" class="text-xl sm:text-2xl text-blue-600 font-semibold"></span>
                    </div>
                    <button onclick="leaveRoom()" 
                            class="bg-red-500 text-white py-2 px-6 rounded-lg hover:bg-red-600 transition duration-200 text-sm sm:text-base font-medium">
                        Leave Room
                    </button>
                </div>
                
                <div id="messages" class="h-[60vh] sm:h-[65vh] overflow-y-auto border border-gray-200 rounded-lg p-4 space-y-3 bg-gray-50">
                    <!-- Messages will be inserted here -->
                </div>
                
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="message" placeholder="Type your message..." 
                           class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                    <button onclick="sendMessage()" 
                            class="w-full sm:w-auto bg-blue-500 text-white py-3 px-8 rounded-lg hover:bg-blue-600 transition duration-200 font-medium">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentUsername = '';
        let currentRoom = '';
        
        // Local Storage Keys
        const STORAGE_KEY = 'chatApp';
        const EXPIRY_KEY = 'chatAppExpiry';
        
        // Initialize from localStorage if exists
        function initFromStorage() {
            const stored = localStorage.getItem(STORAGE_KEY);
            const expiry = localStorage.getItem(EXPIRY_KEY);
            
            if (stored && expiry) {
                const now = new Date().getTime();
                if (now < parseInt(expiry)) {
                    const data = JSON.parse(stored);
                    if (data.username && data.room) {
                        document.getElementById('username').value = data.username;
                        document.getElementById('room').value = data.room;
                        joinRoom(true); // true means joining from storage
                        
                        // Restore messages
                        if (data.messages) {
                            const messagesDiv = document.getElementById('messages');
                            data.messages.forEach(msg => {
                                displayMessage(msg);
                            });
                            messagesDiv.scrollTop = messagesDiv.scrollHeight;
                        }
                    }
                } else {
                    // Clear expired data
                    localStorage.removeItem(STORAGE_KEY);
                    localStorage.removeItem(EXPIRY_KEY);
                }
            }
        }
        
        // Save to localStorage with 24-hour expiry
        function saveToStorage() {
            const data = {
                username: currentUsername,
                room: currentRoom,
                messages: getStoredMessages()
            };
            
            const now = new Date().getTime();
            const expiryTime = now + (24 * 60 * 60 * 1000); // 24 hours from now
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            localStorage.setItem(EXPIRY_KEY, expiryTime.toString());
        }
        
        // Get stored messages from the messages div
        function getStoredMessages() {
            const messages = [];
            const messagesDiv = document.getElementById('messages');
            const messageElements = messagesDiv.children;
            
            for (let element of messageElements) {
                const isSystem = element.classList.contains('text-center');
                messages.push({
                    html: element.outerHTML,
                    isSystem: isSystem
                });
            }
            
            return messages;
        }
        
        // Display a message (either new or from storage)
        function displayMessage(data) {
            const messagesDiv = document.getElementById('messages');
            
            if (data.html) {
                // Message from storage
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = data.html;
                messagesDiv.appendChild(tempDiv.firstChild);
            } else {
                // New message
                const messageElement = document.createElement('div');
                const isSystem = data.user === 'System';
                const isCurrentUser = data.user === currentUsername;
                
                messageElement.className = isSystem 
                    ? 'text-center text-gray-500 text-sm py-1' 
                    : `flex ${isCurrentUser ? 'justify-end' : 'justify-start'}`;
                
                if (isSystem) {
                    messageElement.innerHTML = data.message;
                } else {
                    const timestamp = new Date().toLocaleTimeString();
                    messageElement.innerHTML = `
                        <div class="${isCurrentUser ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800'} 
                                    rounded-lg py-2 px-4 max-w-[80%] break-words">
                            ${isCurrentUser ? '' : `<span class="font-semibold text-sm block">${data.user}</span>`}
                            <span class="block">${data.message}</span>
                            <span class="text-xs ${isCurrentUser ? 'text-blue-100' : 'text-gray-500'} block text-right">${timestamp}</span>
                        </div>
                    `;
                }
                
                messagesDiv.appendChild(messageElement);
            }
            
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            saveToStorage();
        }

        function joinRoom(fromStorage = false) {
            const usernameInput = document.getElementById('username').value.trim();
            const roomInput = document.getElementById('room').value.trim();
            
            if (usernameInput && roomInput) {
                currentUsername = usernameInput;
                currentRoom = roomInput;
                
                if (!fromStorage) {
                    socket.emit('join', { username: currentUsername, room: currentRoom });
                }
                
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('chat-interface').classList.remove('hidden');
                document.getElementById('room-display').textContent = currentRoom;
                
                saveToStorage();
            } else {
                alert('Please enter both username and room name');
            }
        }

        function leaveRoom() {
            socket.emit('leave', { username: currentUsername });
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('chat-interface').classList.add('hidden');
            document.getElementById('messages').innerHTML = '';
            document.getElementById('username').value = currentUsername;
            document.getElementById('room').value = '';
            
            localStorage.removeItem(STORAGE_KEY);
            localStorage.removeItem(EXPIRY_KEY);
            
            currentUsername = '';
            currentRoom = '';
        }

        function sendMessage() {
            const messageInput = document.getElementById('message');
            const message = messageInput.value.trim();
            
            if (message) {
                socket.emit('message', { username: currentUsername, message: message });
                messageInput.value = '';
            }
        }

        // Handle Enter key
        document.getElementById('message').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Prevent accidental page reload
        window.addEventListener('beforeunload', function(e) {
            if (currentUsername && currentRoom) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        socket.on('message', function(data) {
            displayMessage(data);
        });

        // Initialize from storage when page loads
        document.addEventListener('DOMContentLoaded', initFromStorage);
    </script>
</body>
</html>
